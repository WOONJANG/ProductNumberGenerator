<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>품번 생성기 | 브랜드-년도-월-소재-품목-넘버-홈/어웨이</title>
  <style>
    :root{--bg:#0b0b10;--panel:#12121a;--ink:#eef0f8;--muted:#a3a7bf;--bd:#232334}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:22px auto;padding:16px}
    h1{font-size:20px;margin:0 0 10px}
    .card{background:#12121a;border:1px solid var(--bd);border-radius:12px;padding:14px;margin:10px 0}
    label{font-size:12px;color:#b8bdd7;display:block;margin:0 0 4px}
    select,input,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #2a2a44;background:#0b0b13;color:var(--ink)}
    textarea{min-height:64px}
    button{cursor:pointer;border:0;border-radius:10px;padding:8px 12px;background:#5566cc;color:#fff;font-weight:700}
    button.secondary{background:transparent;border:1px solid #2a2a44}
    .sku{font-family:ui-monospace,monospace;background:#07070c;border:1px solid #202033;border-radius:10px;padding:10px 12px;font-size:18px;margin-top:8px}

    .toolbar{display:flex;gap:12px;align-items:flex-end;overflow:auto;padding-bottom:8px}
    .toolbar .field{min-width:160px}
    .toolbar .field.year{min-width:120px}
    .toolbar .field.month,.toolbar .field.ha,.toolbar .field.number{min-width:120px}
    .toolbar::-webkit-scrollbar{height:10px}
    .toolbar::-webkit-scrollbar-thumb{background:#2a2a44;border-radius:6px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}.toolbar{flex-wrap:wrap;overflow:visible}}

    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none}
    .list{border:1px solid #2a2a44;border-radius:10px;overflow:hidden}
    .list table{width:100%;border-collapse:collapse}
    .list th,.list td{border-bottom:1px solid #202033;padding:8px 10px;text-align:left;font-size:13px}
    .list th{background:#0e0e16;color:#c8ccec}
    .row-flex{display:flex;gap:8px;align-items:center}
    .row-flex input{flex:1}
  </style>

  <!-- 배포한 GAS 웹앱 URL을 넣으세요 -->
  <script>
    const CONFIG = {
      ENDPOINT: 'https://script.google.com/macros/s/AKfycbzjR9c7lFsqrYeOnn0mPEJ8pL931H01sfbg5rFCOriptmkCU79vs6zABjmCLUid68wLNA/exec' // ← 교체
    };
  </script>
</head>
<body>
  <div class="wrap">
    <h1>품번 생성기 (브랜드-년도-월-소재-품목-넘버-홈/어웨이)</h1>

    <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div class="muted">Google 스프레드시트 연동 상태: <span id="syncStatus">대기</span></div>
      <div>
        <button id="btnRefresh">데이터 새로고침</button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="field brand">
          <label>브랜드</label>
          <select id="brand"></select>
        </div>
        <div class="field year">
          <label>년도</label>
          <input id="year" type="number" min="2000" max="2099" value="2025"/>
          <div class="muted">년도코드: A=1 … J=0 (끝자리)</div>
        </div>
        <div class="field month">
          <label>월</label>
          <select id="month">
            <option value="01">01</option><option value="02">02</option><option value="03">03</option>
            <option value="04">04</option><option value="05">05</option><option value="06">06</option>
            <option value="07">07</option><option value="08" selected>08</option><option value="09">09</option>
            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
          </select>
        </div>
        <div class="field ha">
          <label>홈/어웨이</label>
          <select id="ha">
            <option value="H">H — 홈</option>
            <option value="A">A — 어웨이</option>
          </select>
        </div>
        <div class="field material">
          <label>소재</label>
          <select id="material"></select>
        </div>
        <div class="field item">
          <label>품목</label>
          <select id="item"></select>
        </div>
        <div class="field number">
          <label>넘버</label>
          <select id="number"></select>
        </div>
      </div>
    </div>

    <div class="card">
      <label>생성된 품번</label>
      <div id="sku" class="sku">-</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnCopy">복사</button>
        <button id="btnCopyNoHy" class="secondary">하이픈 제거 복사</button>
      </div>
      <div class="muted" style="margin-top:6px">형식: 브랜드-년도-월-소재-품목-넘버-홈/어웨이</div>
    </div>

    <!-- 코드 관리 -->
    <div class="card">
      <div class="row-flex" style="justify-content:space-between">
        <strong>코드 관리</strong>
        <button id="manageToggle" class="secondary">열기</button>
      </div>
      <div id="managePanel" class="hidden" style="margin-top:12px">
        <div class="grid">
          <!-- 브랜드 -->
          <div style="grid-column: span 6">
            <div class="row-flex" style="justify-content:space-between">
              <h4 style="margin:6px 0">브랜드</h4>
              <button class="secondary addBtn" data-type="brand">추가</button>
            </div>
            <div class="list"><table><thead><tr><th style="width:120px">코드</th><th>이름</th></tr></thead><tbody id="list-brand"></tbody></table></div>
            <div id="add-brand" class="hidden" style="margin-top:8px">
              <div class="row-flex">
                <input id="new-brand-code" placeholder="코드 (예: J)">
                <input id="new-brand-name" placeholder="이름 (예: 정관장)">
                <button class="saveBtn" data-type="brand">저장</button>
                <button class="secondary cancelBtn" data-type="brand">취소</button>
              </div>
            </div>
          </div>
          <!-- 소재 -->
          <div style="grid-column: span 6">
            <div class="row-flex" style="justify-content:space-between">
              <h4 style="margin:6px 0">소재</h4>
              <button class="secondary addBtn" data-type="material">추가</button>
            </div>
            <div class="list"><table><thead><tr><th style="width:120px">코드</th><th>이름</th></tr></thead><tbody id="list-material"></tbody></table></div>
            <div id="add-material" class="hidden" style="margin-top:8px">
              <div class="row-flex">
                <input id="new-material-code" placeholder="코드 (예: P)">
                <input id="new-material-name" placeholder="이름 (예: 폴리)">
                <button class="saveBtn" data-type="material">저장</button>
                <button class="secondary cancelBtn" data-type="material">취소</button>
              </div>
            </div>
          </div>
          <!-- 품목 -->
          <div style="grid-column: span 6">
            <div class="row-flex" style="justify-content:space-between">
              <h4 style="margin:6px 0">품목</h4>
              <button class="secondary addBtn" data-type="item">추가</button>
            </div>
            <div class="list"><table><thead><tr><th style="width:120px">코드</th><th>이름</th></tr></thead><tbody id="list-item"></tbody></table></div>
            <div id="add-item" class="hidden" style="margin-top:8px">
              <div class="row-flex">
                <input id="new-item-code" placeholder="코드 (예: 18)">
                <input id="new-item-name" placeholder="이름 (예: 유니폼)">
                <button class="saveBtn" data-type="item">저장</button>
                <button class="secondary cancelBtn" data-type="item">취소</button>
              </div>
            </div>
          </div>
          <!-- 넘버 -->
          <div style="grid-column: span 6">
            <div class="row-flex" style="justify-content:space-between">
              <h4 style="margin:6px 0">넘버</h4>
              <button class="secondary addBtn" data-type="number">추가</button>
            </div>
            <div class="list"><table><thead><tr><th style="width:120px">코드</th><th>이름</th></tr></thead><tbody id="list-number"></tbody></table></div>
            <div id="add-number" class="hidden" style="margin-top:8px">
              <div class="row-flex">
                <input id="new-number-code" placeholder="코드 (예: 2)">
                <input id="new-number-name" placeholder="이름 (예: 레플리카)">
                <button class="saveBtn" data-type="number">저장</button>
                <button class="secondary cancelBtn" data-type="number">취소</button>
              </div>
            </div>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">
          ※ 현재 웹앱과 연동되어 <strong>읽기(GET)</strong>와 <strong>추가 저장(POST)</strong>을 지원합니다.
        </div>
      </div>
    </div>
  </div>

  <script>
    const YEAR_CODE={0:'J',1:'A',2:'B',3:'C',4:'D',5:'E',6:'F',7:'G',8:'H',9:'I'};
    const defaultData={
      brand:{'J':'정관장','V':'브이엑스'},
      material:{'P':'폴리','C':'면'},
      item:{'18':'유니폼','01':'패딩'},
      number:{'1':'어센틱','2':'레플리카'}
    };

    async function fetchFromSheet(){
      const status=document.getElementById('syncStatus');
      if(!CONFIG.ENDPOINT){ status.textContent='엔드포인트 미설정'; return; }
      status.textContent='불러오는 중…';
      try{
        const res = await fetch(CONFIG.ENDPOINT, { method:'GET' });
        const text = await res.text(); // 디버그를 위해 텍스트 우선
        if(!res.ok) throw new Error('HTTP '+res.status+' '+text.slice(0,180));
        let data;
        try{ data = JSON.parse(text); }catch(e){ throw new Error('JSON 파싱 실패: '+text.slice(0,180)); }
        ['brand','material','item','number'].forEach(k=>{
          if(data && data[k]) defaultData[k]=data[k];
        });
        status.textContent='동기화 완료';
        loadOptions();
        if(!document.getElementById('managePanel').classList.contains('hidden')) renderLists();
      }catch(e){
        status.textContent='동기화 실패';
        console.error(e);
        alert('동기화 실패: '+ e.message);
      }
    }

    function loadOptions(){
      ['brand','material','item','number'].forEach(key=>{
        const sel=document.getElementById(key);
        sel.innerHTML='';
        Object.keys(defaultData[key]).sort().forEach(code=>{
          const opt=document.createElement('option');
          opt.value=code; opt.textContent=code+' — '+defaultData[key][code];
          sel.appendChild(opt);
        });
      });
      buildSKU();
    }

    function toYearCode(y){ return YEAR_CODE[Number(String(y).slice(-1))]; }

    function buildSKU(){
      const b=document.getElementById('brand').value;
      const yC=toYearCode(document.getElementById('year').value);
      const m=document.getElementById('month').value;
      const mat=document.getElementById('material').value;
      const it=document.getElementById('item').value.padStart(2,'0');
      const num=document.getElementById('number').value;
      const ha=document.getElementById('ha').value;
      const withHy=[b, yC+m, mat+it, num+ha].join('-');
      const noHy=b+yC+m+mat+it+num+ha;
      document.getElementById('sku').textContent=withHy;
      document.getElementById('btnCopyNoHy').onclick=()=>navigator.clipboard.writeText(noHy);
    }

    function renderLists(){
      ['brand','material','item','number'].forEach(t=>{
        const tbody=document.getElementById('list-'+t);
        tbody.innerHTML='';
        Object.entries(defaultData[t]).forEach(([code,name])=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td class="mono">${code}</td><td>${name}</td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function showAddRow(type, show){
      const row=document.getElementById('add-'+type);
      if(show) row.classList.remove('hidden'); else row.classList.add('hidden');
    }

    function wireManagePanel(){
      // 열기/닫기
      document.getElementById('manageToggle').addEventListener('click',()=>{
        const panel=document.getElementById('managePanel');
        const nowHidden = panel.classList.toggle('hidden');
        document.getElementById('manageToggle').textContent = nowHidden ? '열기' : '닫기';
        if(!nowHidden) renderLists();
      });

      // 추가 폼 표시/취소
      document.querySelectorAll('.addBtn').forEach(btn=>{
        btn.addEventListener('click',()=> showAddRow(btn.dataset.type,true));
      });
      document.querySelectorAll('.cancelBtn').forEach(btn=>{
        btn.addEventListener('click',()=> showAddRow(btn.dataset.type,false));
      });

      // 저장 → 서버 POST(시트 반영)
      document.querySelectorAll('.saveBtn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const type = btn.dataset.type;
          const codeEl = document.getElementById('new-'+type+'-code');
          const nameEl = document.getElementById('new-'+type+'-name');
          const code = (codeEl.value||'').trim();
          const name = (nameEl.value||'').trim();
          if(!code || !name){ alert('코드와 이름을 입력하세요.'); return; }

          // 프론트 1차 중복 검사(서버에서도 검사)
          if (defaultData[type] && defaultData[type][code]) {
            alert('이미 존재하는 코드입니다: ' + code);
            return;
          }

          const status=document.getElementById('syncStatus');
          status.textContent='저장 중…';

          try{
            const res = await fetch(CONFIG.ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type, code, name })
            });
            const text = await res.text();
            if(!res.ok) throw new Error('HTTP '+res.status+' '+text.slice(0,180));
            const json = JSON.parse(text);
            if(!json.ok) throw new Error(json.error || 'save failed');

            // 최신 데이터 반영
            ['brand','material','item','number'].forEach(k=>{
              if(json.data && json.data[k]) defaultData[k] = json.data[k];
            });
            loadOptions();
            renderLists();
            showAddRow(type,false);
            codeEl.value=''; nameEl.value='';
            status.textContent='저장 완료';
          }catch(err){
            console.error(err);
            document.getElementById('syncStatus').textContent = '저장 실패';
            alert('저장 실패: '+ err.message);
          }
        });
      });
    }

    // 이벤트 바인딩
    ['brand','year','month','material','item','number','ha'].forEach(id=>{
      document.getElementById(id).addEventListener('input',buildSKU);
    });
    document.getElementById('btnCopy').addEventListener('click',()=>navigator.clipboard.writeText(document.getElementById('sku').textContent));
    document.getElementById('btnRefresh').addEventListener('click',fetchFromSheet);

    // 초기 실행
    loadOptions();
    fetchFromSheet();
    wireManagePanel();
  </script>
</body>
</html>
